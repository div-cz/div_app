{% extends "divkvariat/base.html" %}

{% block content %}

<div class="homepage">
    <h1 class="homepage-title">DIVkvari√°t</h1>
    <p class="homepage-intro">
        Burza knih mezi ƒçten√°≈ôi ‚Äì p≈ôehledn√© nab√≠dky a popt√°vky z druh√© ruky.<br>
        Nab√≠dku m≈Ø≈æete zadat z detailu knihy nebo
        <a href="/pridat-knihu/" class="link-green">
            p≈ôes formul√°≈ô p≈ôidat knihu
        </a>.
    </p>

    {% if request.user.is_authenticated and request.user.is_superuser %}
        <div class="admin-alert">
            <strong>üí∞ Administrace ‚Äì z√°vazky k vyplacen√≠:</strong><br>
            Celkem ƒçek√° na vyplacen√≠
            <span class="admin-amount">
                {{ pending_payout|floatformat:0 }} Kƒç
            </span>
        </div>
    {% endif %}

    <!-- Statistiky -->
    <div class="stats-grid">

        <div class="stat-card">
            <div class="stat-title">
                <i class="fas fa-book"></i> Nab√≠dky
            </div>
            <a href="/nabidky/" class="stat-value">
                {{ count_sell }} aktivn√≠ch knih k prodeji ƒçi darov√°n√≠
            </a>
        </div>

        <div class="stat-card">
            <div class="stat-title">
                <i class="fas fa-hand-holding-heart"></i> Popt√°vky
            </div>
            <a href="/poptavky/" class="stat-value">
                {{ count_buy }} ƒçten√°≈ôsk√Ωch p≈ô√°n√≠
            </a>
        </div>

        {% if request.user.is_authenticated %}
            <div class="stat-card stat-card-muted">
                <div class="stat-title">
                    <i class="fas fa-money-bill-wave"></i> V√Ωplata
                </div>

                <ul class="payout-list">
                    <li><strong>K vyplacen√≠:</strong> {{ total_user_payment|default:"0" }} Kƒç</li>
                    <li><strong>Vyplaceno:</strong> {{ total_user_paid_amount|default:"0" }} Kƒç</li>
                </ul>

                {% if total_user_payment > 0 and button_appear %}
                    {% if user.userprofile.bankaccount %}
                        <form method="post" class="payout-form">
                            {% csrf_token %}
                            <button type="submit" name="request_payout" class="btn-primary">
                                Vy≈æ√°dat v√Ωplatu
                            </button>
                        </form>
                        
                        {% else %}
                        <p class="payout-warning">
                            Pro v√Ωplatu je nutn√© vyplnit ƒç√≠slo √∫ƒçtu na
                            <a href="/ucet/upravit/" class="link-green">profilu</a>.
                        </p>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Nejnovƒõj≈°√≠ nab√≠dky -->
    {% if listings_sell %}
        <h2 class="section-title">
            <i class="fas fa-book-open"></i> Nejnovƒõj≈°√≠ nab√≠dky
        </h2>

        <div class="listing-grid">
            {% for listing in listings_sell %}
                <div class="listing-card">

                    <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}">
                        {% if listing.book.img == "noimg.png" %}
                            <img src="https://media.div.cz/img/book/book.png" class="listing-image">
                        {% elif listing.book.img == "GoogleID" %}
                            <img src="https://books.google.com/books/content?id={{ listing.book.googleid }}&printsec=frontcover&img=1&zoom=1" class="listing-image">
                        {% else %}
                            <img src="https://media.div.cz/knihy/{{ listing.book.img }}" class="listing-image">
                        {% endif %}
                    </a>

                    <div class="listing-body">
                        <h3 class="listing-title">
                            {{ listing.book.titlecz|default:listing.book.title }}
                        </h3>
                        <p class="listing-author">
                            {{ listing.book.author }}
                        </p>
                    </div>

                    <div class="listing-footer">
                        <div class="listing-price">
                            {% if listing.price %}
                                {{ listing.price|floatformat:0 }} Kƒç
                            {% else %}
                                Daruji
                            {% endif %}
                        </div>

                        <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}"
                        class="btn-primary btn-block">
                            Detail nab√≠dky
                        </a>
                    </div>

                </div>
            {% endfor %}
        </div>

        <!-- Paginace -->
        <div class="pagination">
            {% if listings_sell.has_previous %}
                <a href="?page_sell={{ listings_sell.previous_page_number }}">¬´ P≈ôedchoz√≠</a>
            {% endif %}

            <span class="pagination-current">
                Strana {{ listings_sell.number }} z {{ listings_sell.paginator.num_pages }}
            </span>

            {% if listings_sell.has_next %}
                <a href="?page_sell={{ listings_sell.next_page_number }}">Dal≈°√≠ ¬ª</a>
            {% endif %}
        </div>
    {% endif %}

</div>

{% endblock %}
