{% extends "divkvariat/base.html" %}
{% load humanize %}

{% block title %}
{{ profile_user.username }} ‚Äì Moje nab√≠dky | DIVkvari√°t
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-10">

    <!-- HLAVIƒåKA -->
    <h1 class="text-3xl font-bold text-gray-800 mb-2">
        {{ profile_user.username }} ‚Äì Moje nab√≠dky
    </h1>
    <p class="text-gray-600 mb-8">
        P≈ôehled v≈°ech va≈°ich prodej≈Ø, popt√°vek a archivovan√Ωch nab√≠dek.
    </p>

    <!-- TABS -->
    <div class="flex flex-wrap gap-3 mb-6">
        {% for key,label in tabs %}
        <a href="?type={{ key }}"
           class="px-4 py-2 rounded-lg border shadow-sm
           {% if filter_type == key %}
               bg-green-100 border-green-300 text-green-800
           {% else %}
               bg-white text-gray-700 hover:bg-gray-50
           {% endif %}">
            {{ label }}
        </a>
        {% endfor %}
    </div>

    <!-- ≈òAZEN√ç -->
    <form method="get" class="flex flex-wrap items-center gap-4 mb-6 text-sm text-gray-700">
        <input type="hidden" name="type" value="{{ filter_type }}">
        <span class="font-semibold">≈òadit:</span>

        <label class="flex items-center gap-1">
            <input type="radio" name="order" value="date" {% if order == "date" %}checked{% endif %}>
            podle data
        </label>

        <label class="flex items-center gap-1">
            <input type="radio" name="order" value="alpha" {% if order == "alpha" %}checked{% endif %}>
            A‚ÄìZ
        </label>

        <button class="ml-2 px-3 py-1 border rounded-lg bg-white hover:bg-gray-50">
            Pou≈æ√≠t
        </button>
    </form>

    <!-- ABECEDA -->
    <div class="flex flex-wrap gap-1 mb-8 text-sm">
        <a href="?type={{ filter_type }}&order={{ order }}"
           class="px-2 py-1 rounded
           {% if not active_letter %}
               bg-green-600 text-white
           {% else %}
               bg-gray-100 hover:bg-gray-200
           {% endif %}">
            V≈°e
        </a>
        {% for letter in alphabet %}
        <a href="?type={{ filter_type }}&order={{ order }}&letter={{ letter }}"
           class="px-2 py-1 rounded
           {% if active_letter == letter %}
               bg-green-600 text-white
           {% else %}
               bg-gray-100 hover:bg-gray-200
           {% endif %}">
            {{ letter }}
        </a>
        {% endfor %}
    </div>

    <!-- FORMUL√Å≈ò -->
    <form method="post">
        {% csrf_token %}

        {% if listings %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

            {% for listing in listings %}
            <div class="bg-white border rounded-xl shadow-sm hover:shadow-md transition p-4">

                <!-- CHECKBOX -->
                {% if listing.status == "ACTIVE" %}
                <div class="mb-2">
                    <label class="text-sm text-gray-600 flex items-center gap-2">
                        <input type="checkbox" name="selected_ids" value="{{ listing.booklistingid }}"
                               class="rounded">
                        vybrat
                    </label>
                </div>
                {% endif %}

                <!-- OBSAH -->
                <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}"
                   class="font-semibold text-gray-800 hover:underline block mb-1">
                    {{ listing.book.titlecz|default:listing.book.title }}
                </a>

                <p class="text-sm text-gray-500 mb-2">
                    {{ listing.book.author }}
                </p>

                <!-- CENA - EDITOVATELN√Å -->
                {% if listing.status == "ACTIVE" and listing.listingtype != "GIVE" %}
                <div class="mb-2">
                    <label class="text-xs text-gray-500">Cena:</label>
                    <div class="flex items-center gap-1">
                        <input type="number" 
                               name="price_{{ listing.booklistingid }}" 
                               value="{{ listing.price|floatformat:0 }}"
                               class="w-24 px-2 py-1 border rounded text-sm"
                               min="0">
                        <span class="text-sm text-gray-600">Kƒç</span>
                    </div>
                </div>
                {% else %}
                <p class="text-lg font-bold mb-1
                    {% if listing.listingtype == 'GIVE' %}
                        text-blue-600
                    {% else %}
                        text-green-600
                    {% endif %}">
                    {% if listing.listingtype == "GIVE" %}
                        Daruji
                    {% else %}
                        {{ listing.price|intcomma }} Kƒç
                    {% endif %}
                </p>
                {% endif %}

                <p class="text-xs text-gray-500 mb-3">
                    <span class="font-semibold">{{ listing.get_listingtype_display }}</span> ¬∑
                    <span class="
                        {% if listing.status == 'ACTIVE' %}text-green-600
                        {% elif listing.status == 'RESERVED' %}text-blue-600
                        {% elif listing.status == 'PAID' %}text-yellow-600
                        {% elif listing.status == 'SHIPPED' %}text-purple-600
                        {% elif listing.status == 'COMPLETED' %}text-gray-600
                        {% else %}text-red-600
                        {% endif %}">
                        {{ listing.get_status_display }}
                    </span>
                    <br>
                    {{ listing.createdat|date:"j. n. Y" }}
                </p>

                <!-- AKCE -->
                <div class="flex gap-3 text-sm">
                    {% if listing.status == "ACTIVE" %}
                    <a href="{% url 'listing_detail_edit' listing.book.url listing.booklistingid %}"
                       class="text-green-700 hover:underline">
                        Upravit
                    </a>
                    {% endif %}

                    <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}"
                       class="text-gray-700 hover:underline">
                        Detail
                    </a>

                    {% if listing.status == "ACTIVE" %}
                    <a href="{% url 'cancel_sell' listing.booklistingid %}"
                       class="text-red-600 hover:underline"
                       onclick="return confirm('Opravdu chcete zru≈°it tuto nab√≠dku?')">
                        Zru≈°it
                    </a>
                    {% endif %}
                </div>

            </div>
            {% endfor %}
        </div>

        <!-- HROMADN√â AKCE -->
        <div class="mt-8 p-4 bg-gray-50 border rounded-xl flex flex-wrap gap-4 items-center">
            <button type="submit" name="action" value="update_prices"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                üíæ Ulo≈æit zmƒõny cen
            </button>

            <button type="submit" name="action" value="cancel"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                    onclick="return confirm('Opravdu chcete zru≈°it vybran√© nab√≠dky?')">
                üóëÔ∏è Zru≈°it vybran√©
            </button>

            <span class="text-sm text-gray-600 ml-auto">
                Celkem: {{ listings.paginator.count }} nab√≠dek
            </span>
        </div>

        {% else %}
        <div class="text-center py-16">
            <p class="text-gray-500 text-lg mb-4">
                Zat√≠m zde nem√°te ≈æ√°dn√© nab√≠dky.
            </p>
            <a href="{% url 'listing_add_book' %}" 
               class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                + P≈ôidat prvn√≠ nab√≠dku
            </a>
        </div>
        {% endif %}
    </form>

    <!-- PAGINACE -->
    {% if listings.has_other_pages %}
    <div class="flex justify-center mt-10">
        <nav class="flex items-center gap-2 text-sm">

            {% if listings.has_previous %}
            <a href="?page={{ listings.previous_page_number }}&type={{ filter_type }}&order={{ order }}{% if active_letter %}&letter={{ active_letter }}{% endif %}"
               class="px-3 py-2 bg-white border rounded-lg hover:bg-gray-50">
                ‚Äπ P≈ôedchoz√≠
            </a>
            {% endif %}

            <span class="px-4 py-2 bg-gray-100 border rounded-lg">
                {{ listings.number }} / {{ listings.paginator.num_pages }}
            </span>

            {% if listings.has_next %}
            <a href="?page={{ listings.next_page_number }}&type={{ filter_type }}&order={{ order }}{% if active_letter %}&letter={{ active_letter }}{% endif %}"
               class="px-3 py-2 bg-white border rounded-lg hover:bg-gray-50">
                Dal≈°√≠ ‚Ä∫
            </a>
            {% endif %}

        </nav>
    </div>
    {% endif %}

</div>
{% endblock %}
