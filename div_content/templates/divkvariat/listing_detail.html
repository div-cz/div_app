{% extends "divkvariat/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ listing.get_listingtype_display }} – {{ book.titlecz|default:book.title }} | DIVkvariát
{% endblock %}

{% block content %}

<div class="listing-detail-page">
    <nav class="listing-breadcrumb">
        <a href="/">DIVkvariát</a>
        <span>/</span>
        <a href="{% if listing.listingtype == 'SELL' %}/nabidky/{% else %}/poptavky/{% endif %}">
            {% if listing.listingtype == 'SELL' %}Nabídky{% else %}Poptávky{% endif %}
        </a>
    </nav>

    <div class="listing-layout">
        <!-- HLAVNÍ OBSAH -->
        <main class="listing-main">
            <!-- KNIHA -->
            <div class="listing-book">

                <a href="/kniha/{{ book.url }}" class="listing-book-cover">
                    {% if book.img == "noimg.png" %}
                        <img src="https://div.cz/static/img/book/book.png">
                        {% elif book.img == "GoogleID" %}
                        <img src="https://books.google.com/books/content?id={{ book.googleid }}&printsec=frontcover&img=1&zoom=1">
                        {% else %}
                        <img src="https://media.div.cz/knihy/{{ book.img }}">
                    {% endif %}
                </a>

                <div class="listing-book-info">
                    <h1 class="section-title">
                        <a href="/kniha/{{ book.url }}">
                            {{ book.titlecz|default:book.title }}
                        </a>
                    </h1>
                    <p class="listing-author">{{ book.author }}</p>

                    <div class="listing-price {% if listing.listingtype == 'BUY' %}want{% endif %}">
                        {% if listing.listingtype == 'GIVE' %}
                            Daruji
                            {% else %}
                            {{ listing.price|price }} Kč
                        {% endif %}
                    </div>
                </div>

            </div>

            <!-- HLAVNÍ INFO -->
            <div class="listing-card">

                <div class="listing-header-row">
                    <div>
                        <p class="muted">Vloženo:</p>
                        <p>{{ listing.createdat|date:"j. n. Y" }}</p>
                    </div>

                    <span class="listing-status {{ listing.status|lower }}">
                        {{ listing.get_status_display }}
                    </span>
                </div>

                {% if listing.description %}
                    <div class="listing-description">
                        <strong>Popis:</strong>
                        {{ listing.description|linebreaks }}
                    </div>
                {% endif %}

                <!-- PARAMETRY -->
                <div class="listing-params">
                    {% if listing.condition %}
                        <p><strong>Stav:</strong> {{ listing.get_condition_display }}</p>
                    {% endif %}
                    {% if listing.location %}
                        <p><strong>Lokalita:</strong> {{ listing.location }}</p>
                    {% endif %}
                    <p><strong>Osobní převzetí:</strong>
                        {% if listing.personal_pickup %}Ano{% else %}Ne{% endif %}
                    </p>
                </div>

            </div>

            <!-- GALERIE -->
            {% if listing.images.all %}
                <div class="listing-card">
                    <h3 class="section-subtitle">Fotografie</h3>

                    <div class="listing-gallery">
                        {% for img in listing.images.all %}
                        <img src="{{ img.image.url }}"
                            onclick="openImageModal('{{ img.image.url }}')">
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- AKCE (rezervace / platba / potvrzení) -->
            {% if user.is_authenticated and listing.status == 'ACTIVE' and user != listing.user %}
                <div class="listing-card">
                    <h3 class="section-subtitle">Rezervace knihy</h3>
                    <form method="post">
                        {% csrf_token %}
                        <button class="add-book w-full">
                            Rezervovat knihu
                        </button>
                    </form>
                </div>
            {% endif %}

        </main>

        <!-- SIDEBAR -->
        <aside class="listing-sidebar">
            {% if request.user.is_authenticated %}
                <div class="listing-card">
                    <h3 class="section-subtitle">Můj přehled</h3>
                    <ul class="listing-stats">
                        <li>Prodáno: {{ user_sold_books|default:"0" }}</li>
                        <li>Koupeno: {{ user_buyed_books|default:"0" }}</li>
                        <li>K vyplacení: {{ total_user_payment|default:"0" }} Kč</li>
                    </ul>

                    {% if total_user_payment > 0 and button_appear %}
                        <form method="post">
                            {% csrf_token %}
                            <button class="add-book">
                                Vyžádat výplatu
                            </button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}

        </aside>

    </div>

</div>

{% endblock %}
