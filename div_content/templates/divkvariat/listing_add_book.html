{% extends "divkvariat/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}
Přidat inzerát knihy | DIVkvariát
{% endblock %}

{% block content %}

<div class="form-page">
    <h1 class="section-title">Přidat inzerát knihy</h1>

    <!-- KROK 1 – VYHLEDÁNÍ KNIHY -->
    {% if not selected_book %}
        <div class="form-card">

            <h2 class="form-step-title">1. Vyberte knihu</h2>

            <div class="search-box">
                <input id="book-search" type="text" placeholder="Začněte psát název knihy nebo jméno autora…" autocomplete="off" class="form-input">

                <div id="search-results" class="search-results hidden"></div>
            </div>

        </div>
    {% endif %}

    <!-- KROK 2 – VYBRANÁ KNIHA + FORM -->
    {% if selected_book %}
        <div class="form-card">

            <h2 class="form-step-title">Vybraná kniha</h2>

            <div class="selected-book">

                {% if selected_book.img == "noimg.png" %}
                    <img src="https://div.cz/static/img/book/book.png">
                    {% elif selected_book.img == "GoogleID" %}
                    <img src="https://books.google.com/books/content?id={{ selected_book.googleid }}&printsec=frontcover&img=1&zoom=1">
                    {% else %}
                    <img src="https://media.div.cz/knihy/{{ selected_book.img }}">
                {% endif %}

                <div class="selected-book-info">
                    <h3>{{ selected_book.titlecz|default:selected_book.title }}</h3>
                    <p>{{ selected_book.author }}</p>
                    {% if selected_book.year %}
                        <p class="muted">{{ selected_book.year }}</p>
                    {% endif %}
                    <a href="?book_id=" class="text-link">Změnit knihu</a>
                </div>

            </div>

            <h2 class="form-step-title">2. Vyplňte detaily nabídky</h2>

            <form method="post" class="form-layout">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="booklisting">
                <input type="hidden" name="book_id" value="{{ selected_book.bookid }}">

                <div class="form-grid">

                    <div>
                        <label>Typ nabídky</label>
                        {{ booklisting_form.listingtype|add_class:"form-input" }}
                    </div>

                    <div>
                        <label>Cena</label>
                        {{ booklisting_form.price|add_class:"form-input" }}
                    </div>

                    <div class="full">
                        <label>Popis</label>
                        {{ booklisting_form.description|add_class:"form-input textarea" }}
                    </div>

                    <div>
                        <label>Stav knihy</label>
                        {{ booklisting_form.condition|add_class:"form-input" }}
                    </div>

                    <div>
                        <label>Místo</label>
                        {{ booklisting_form.location|add_class:"form-input" }}
                    </div>

                    <div class="checkbox-row">
                        {{ booklisting_form.personal_pickup }}
                        <label>Osobní převzetí</label>
                    </div>

                    <div>
                        <label>Telefon (volitelně)</label>
                        {{ booklisting_form.phone|add_class:"form-input" }}
                    </div>

                </div>

                <hr>

                <h3 class="form-subtitle">Poštovné</h3>

                <div class="form-grid shipping">

                    <div>
                        <label class="checkbox-label">
                            {{ booklisting_form.shipping_zasilkovna }} Zásilkovna
                        </label>
                        {{ booklisting_form.shipping_zasilkovna_price|add_class:"form-input" }}
                    </div>

                    <div>
                        <label class="checkbox-label">
                            {{ booklisting_form.shipping_balikovna }} Balíkovna
                        </label>
                        {{ booklisting_form.shipping_balikovna_price|add_class:"form-input" }}
                    </div>

                    <div>
                        <label class="checkbox-label">
                            {{ booklisting_form.shipping_posta }} Česká pošta
                        </label>
                        {{ booklisting_form.shipping_posta_price|add_class:"form-input" }}
                    </div>

                </div>

                <button type="submit" class="add-book">
                    Vytvořit nabídku
                </button>

            </form>

        </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('book-search');
        const resultsBox = document.getElementById('search-results');
        if (!searchInput) return;

        let timeout;

        searchInput.addEventListener('input', function () {
            clearTimeout(timeout);
            const q = this.value.trim();
            if (q.length < 2) {
                resultsBox.classList.add('hidden');
                return;
            }

            timeout = setTimeout(() => {
                fetch(`{% url 'listing_search_books' %}?q=` + encodeURIComponent(q), {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(res => res.json())
                .then(data => renderResults(data.results));
            }, 300);
        });

        function renderResults(results) {
            if (!results.length) {
                resultsBox.innerHTML = '<div class="search-empty">Žádné výsledky.</div>';
                resultsBox.classList.remove('hidden');
                return;
            }

            resultsBox.innerHTML = results.map(book => {
                const img =
                    book.img === "noimg.png"
                        ? "https://div.cz/static/img/book/book.png"
                        : book.img === "GoogleID"
                            ? `https://books.google.com/books/content?id=${book.googleid}&printsec=frontcover&img=1&zoom=1`
                            : `https://media.div.cz/knihy/${book.img}`;

                return `
                    <div class="search-item" onclick="selectBook(${book.bookid})">
                        <img src="${img}">
                        <div>
                            <strong>${book.title}</strong>
                            <div class="muted">${book.author}${book.year ? ' (' + book.year + ')' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsBox.classList.remove('hidden');
        }

        document.addEventListener("click", function (e) {
            if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                resultsBox.classList.add("hidden");
            }
        });
    });

    function selectBook(id) {
        window.location.href = "?book_id=" + id;
    }
</script>

{% endblock %}
