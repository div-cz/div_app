{% extends "divkvariat/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}
    Přidat inzerát knihy | DIVkvariát
{% endblock %}


    {% block meta %}
<style>
/* === UNIVERZÁLNÍ FORM CONTROL === */
input[type="text"],
input[type="number"],
input[type="email"],
input[type="tel"],
select,
textarea {
    height: 48px;
    padding: 10px 14px;
    font-size: 16px;
    line-height: 1.4;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    background-color: #fff;
    box-sizing: border-box;
    width: 100%;
}

/* textarea výjimka */
textarea {
    height: auto;
    min-height: 140px;
    padding:10px !important;
    cursor: text;
}

/* === SELECT – srovnat text vertikálně === */
select {
    padding-right: 40px;          /* místo pro šipku */
    line-height: 1.4;
}

/* === NUMBER INPUT (ROK) – spinner fix === */
input[type="number"] {
    appearance: textfield;
    -moz-appearance: textfield;
}

/* Chrome / Safari – spinner */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    height: 100%;
}

/* === CHECKBOXY – větší a konzistentnější === */
input[type="checkbox"] {
    width: 24px;
    height: 24px;
    accent-color: #22c55e;
    cursor: pointer;
    flex-shrink: 0;
}

label {
    cursor: pointer;
}

</style>
    {% endblock %}


{% block content %}

<div class="max-w-4xl mx-auto py-10">

    <h1 class="text-3xl font-bold mb-8">Přidat inzerát knihy</h1>


    <!-- KROK 1 – VYHLEDÁNÍ KNIHY -->
    {% if not selected_book %}
    <div class="bg-white shadow rounded-lg p-6 mb-10">

        <h2 class="text-2xl font-semibold mb-4">1. Vyberte knihu</h2>

        <div class="relative">
            <input 
                id="book-search"
                type="text"
                placeholder="Začněte psát název knihy nebo jméno autora..."
                autocomplete="off"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 outline-none"
            >

            <div id="search-results"
                 class="absolute mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-72 overflow-y-auto hidden z-50">
            </div>
        </div>

    </div>
    {% endif %}


    <!-- KROK 2 – ZOBRAZENÍ VYBRANÉ KNIHY + FORM -->
    {% if selected_book %}
    <div class="bg-white shadow rounded-lg p-6">

        <h2 class="text-2xl font-semibold mb-6">Vybraná kniha</h2>

        <div class="flex gap-4 mb-6">
            {% if selected_book.img == "noimg.png" %}
            <img src="https://div.cz/static/img/book/book.png" class="w-28 rounded shadow">
            {% elif selected_book.img == "GoogleID" %}
            <img src="https://books.google.com/books/content?id={{ selected_book.googleid }}&printsec=frontcover&img=1&zoom=1"
                 class="w-28 rounded shadow">
            {% else %}
            <img src="https://media.div.cz/knihy/{{ selected_book.img }}" class="w-28 rounded shadow">
            {% endif %}

            <div>
                <h3 class="text-xl font-bold">{{ selected_book.titlecz|default:selected_book.title }}</h3>
                <p class="text-gray-600">{{ selected_book.author }}</p>
                {% if selected_book.year %}
                <p class="text-gray-500">{{ selected_book.year }}</p>
                {% endif %}
                <a href="?book_id=" class="text-green-600 hover:underline text-sm">Změnit knihu</a>
            </div>
        </div>

        <h2 class="text-2xl font-semibold mb-4">2. Vyplňte detaily nabídky</h2>

        <form method="post" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="booklisting">
            <input type="hidden" name="book_id" value="{{ selected_book.bookid }}">

            <div class="space-y-4">

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Typ nabídky -->
    <div>
        <label class="font-medium block mb-1">{{ booklisting_form.listingtype.label }}</label>
        {{ booklisting_form.listingtype }}
    </div>

    <!-- Cena -->
    <div>
        <label class="font-medium block mb-1">{{ booklisting_form.price.label }}</label>
        {{ booklisting_form.price }}
    </div>

    <!-- Popis -->
    <div class="md:col-span-2">
        <label class="font-medium block mb-1">{{ booklisting_form.description.label }}</label>
        {{ booklisting_form.description }}
    </div>

    <!-- Stav -->
    <div>
        <label class="font-medium block mb-1">{{ booklisting_form.condition.label }}</label>
        {{ booklisting_form.condition }}
    </div>

    <!-- Rok vydání -->
    <div>
        <label class="font-medium block mb-1">{{ booklisting_form.editionyear.label }}</label>
        {{ booklisting_form.editionyear }}
    </div>

    <!-- První vydání -->
    <div class="md:col-span-2 flex items-center gap-3 mt-2">
        {{ booklisting_form.firstedition }}
        <label class="font-medium select-none">
            {{ booklisting_form.firstedition.label }}
        </label>
    </div>

    <!-- Ediční poznámka -->
    <div class="md:col-span-2">
        <label class="font-medium block mb-1">{{ booklisting_form.edition_note.label }}</label>
        {{ booklisting_form.edition_note }}
    </div>

    <!-- Místo -->
    <div>
        <label class="font-medium block mb-1">{{ booklisting_form.location.label }}</label>
        {{ booklisting_form.location }}
    </div>

    <!-- Telefon -->
    <div>
        <label class="font-medium block mb-1">{{ booklisting_form.phone.label }}</label>
        {{ booklisting_form.phone }}
    </div>

    <!-- Osobní převzetí -->
    <div class="md:col-span-2 flex items-center gap-3 mt-2">
        {{ booklisting_form.personal_pickup }}
        <label class="font-medium select-none">{{ booklisting_form.personal_pickup.label }}</label>
    </div>

</div>

<hr class="my-6">

<h3 class="text-xl font-semibold mb-4">Poštovné</h3>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <div>
        <label class="flex items-center gap-3 font-medium mb-2">
            {{ booklisting_form.shipping_zasilkovna }}
            <span>Zásilkovna</span>
        </label>
        {{ booklisting_form.shipping_zasilkovna_price }}
    </div>

    <div>
        <label class="flex items-center gap-3 font-medium mb-2">
            {{ booklisting_form.shipping_balikovna }}
            <span>Balíkovna</span>
        </label>
        {{ booklisting_form.shipping_balikovna_price }}
    </div>

    <div>
        <label class="flex items-center gap-3 font-medium mb-2">
            {{ booklisting_form.shipping_posta }}
            <span>Česká pošta</span>
        </label>
        {{ booklisting_form.shipping_posta_price }}
    </div>

</div>


            </div>

            <button type="submit"
                    class="add-book mt-4">
                Vytvořit nabídku
            </button>
        </form>

    </div>
    {% endif %}

</div>


<!-- SCRIPT – AJAX VYHLEDÁVÁNÍ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('book-search');
    const resultsBox = document.getElementById('search-results');

    if (!searchInput) return;

    let timeout;

    searchInput.addEventListener('input', function () {

        clearTimeout(timeout);
        const q = this.value.trim();

        if (q.length < 2) {
            resultsBox.classList.add('hidden');
            return;
        }

        timeout = setTimeout(() => {
            fetch(`{% url 'listing_search_books' %}?q=` + encodeURIComponent(q), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => renderResults(data.results));
        }, 300);
    });

    function renderResults(results) {

        if (!results.length) {
            resultsBox.innerHTML = `
                <div class="p-3 text-gray-500">Žádné výsledky.</div>
            `;
            resultsBox.classList.remove('hidden');
            return;
        }

        let html = "";

        results.forEach(book => {
            let imgSrc =
                book.img === "noimg.png" ? "https://div.cz/static/img/book/book.png" :
                book.img === "GoogleID"
                    ? `https://books.google.com/books/content?id=${book.googleid}&printsec=frontcover&img=1&zoom=1`
                    : `https://media.div.cz/knihy/${book.img}`;

            html += `
                <div onclick="selectBook(${book.bookid})"
                     class="flex items-center gap-4 px-3 py-2 cursor-pointer hover:bg-gray-100 border-b">
                     
                    <img src="${imgSrc}" class="w-12 rounded">
                    
                    <div>
                        <div class="font-semibold">${book.title}</div>
                        <div class="text-sm text-gray-600">${book.author}${book.year ? ' (' + book.year + ')' : ''}</div>
                    </div>

                </div>
            `;
        });

        resultsBox.innerHTML = html;
        resultsBox.classList.remove('hidden');
    }

    document.addEventListener("click", function (e) {
        if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
            resultsBox.classList.add("hidden");
        }
    });
});

function selectBook(id) {
    window.location.href = "?book_id=" + id;
}
</script>

{% endblock %}