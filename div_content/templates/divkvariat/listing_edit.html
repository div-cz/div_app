{% extends "divkvariat/base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}
Upravit nabídku – {{ book.titlecz|default:book.title }} | DIVkvariát
{% endblock %}

{% block content %}

<div class="page">
    <nav class="breadcrumb">
        <a href="/">DIVkvariát</a>
        <span>/</span>
        <a href="{% url 'listing_detail_sell' book_url=book.url listing_id=listing.booklistingid %}">
            Zpět na nabídku
        </a>
    </nav>

    <div class="layout">

        <!-- HLAVNÍ OBSAH -->
        <main class="layout-main">

            <!-- HLAVIČKA -->
            <section class="card">
                <h1 class="page-title">Upravit nabídku</h1>
                <div class="book-header">
                    <a href="/kniha/{{ book.url }}" class="book-cover">
                        {% if book.img == "noimg.png" %}
                            <img src="/static/img/book/book.png">
                        {% elif book.img == "GoogleID" %}
                            <img src="https://books.google.com/books/content?id={{ book.googleid }}&printsec=frontcover&img=1&zoom=1">
                        {% else %}
                            <img src="https://media.div.cz/knihy/{{ book.img }}">
                        {% endif %}
                    </a>

                    <div class="book-info">
                        <h2>
                            <a href="/kniha/{{ book.url }}">
                                {{ book.titlecz|default:book.title }}
                            </a>
                        </h2>
                        <p class="book-author">{{ book.author }}</p>
                    </div>
                </div>
            </section>

            <!-- FOTOGRAFIE -->
            <section class="card">
                <h2 class="section-title">Fotografie</h2>

                {% if listing.images.all %}
                    <div class="gallery">
                        {% for img in listing.images.all %}
                            <div class="gallery-item">
                                <img src="{{ img.image.url }}"
                                    onclick="openImageModal('{{ img.image.url }}')">

                                <a href="{% url 'listing_delete_image' img.id %}"
                                class="gallery-delete"
                                onclick="return confirm('Smazat fotografii?');">
                                    ×
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <form method="post" enctype="multipart/form-data"
                      action="{% url 'listing_upload_image' listing.booklistingid %}">
                    {% csrf_token %}
                    <input type="file" name="images" multiple>
                    <button class="btn-primary">Nahrát nové fotografie</button>
                </form>
            </section>

            <!-- FORMULÁŘ -->
            <section class="card">
                <h2 class="section-title">Detaily nabídky</h2>

                <form method="post" class="form">
                    {% csrf_token %}

                    <label>
                        Cena (Kč)
                        <input type="number" name="new_price"
                               value="{{ listing.price|floatformat:0 }}" min="0" required>
                    </label>

                    <fieldset>
                        <legend>Doprava</legend>
                        <input type="number" name="shipping_zasilkovna"
                               value="{{ current_shipping.zasilkovna }}" placeholder="Zásilkovna">
                        <input type="number" name="shipping_balikovna"
                               value="{{ current_shipping.balikovna }}" placeholder="Balíkovna">
                        <input type="number" name="shipping_osobni"
                               value="{{ current_shipping.osobni }}" placeholder="Osobní odběr">
                    </fieldset>

                    <label>
                        Popis
                        <textarea name="new_description" rows="5">{{ listing.description }}</textarea>
                    </label>

                    <div class="form-row">
                        <label>
                            Stav knihy
                            <select name="new_condition">
                                <option value="">– vyberte –</option>
                                {% for key, label in listing.CONDITION_CHOICES %}
                                    <option value="{{ key }}" {% if listing.condition == key %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </label>

                        <label>
                            Lokalita
                            <input type="text" name="new_location"
                                   value="{{ listing.location|default:'' }}">
                        </label>
                    </div>

                    <label class="checkbox">
                        <input type="checkbox" name="new_personal_pickup"
                               {% if listing.personal_pickup %}checked{% endif %}>
                        Umožnit osobní převzetí
                    </label>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Uložit změny</button>
                        <a href="{% url 'listing_detail_sell' book_url=book.url listing_id=listing.booklistingid %}"
                           class="btn-secondary">
                            Zrušit
                        </a>
                    </div>

                </form>
            </section>

        </main>

        <!-- SIDEBAR -->
        <aside class="layout-sidebar">
            <section class="card">
                <h2 class="section-title">Nápověda</h2>
                <ul>
                    <li>Upravit lze pouze aktivní nabídky</li>
                    <li>Reálná cena zvyšuje šanci na prodej</li>
                    <li>Více dopravy = více zájemců</li>
                    <li>Detailní popis zvyšuje důvěru</li>
                </ul>
            </section>
        </aside>

    </div>

</div>

{% endblock %}
