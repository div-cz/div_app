{% extends "awards/base.html" %}
{% load static %}

{% block title %}P콏idat nominaci - {{ award.awardname }} {{ award.year }} - DIV.cz{% endblock %}

{% block meta %}

{% endblock %}

{% block content %}

<h2 style="width: 100%; margin-bottom: 1.6rem;">
    <a href="{% url 'awards_index' %}" 
        class="{% if award.awardtype == 'film' %}movies
        {% elif award.awardtype == 'book' %}books
        {% elif award.awardtype == 'game' %}games{% endif %}">
        Ocen캩n칤
    </a>

    <span> / </span>

    {% if award.awardtype == "film" %}
        <a href="{% url 'awards_movies' %}" class="movies">Filmy</a>
    {% elif award.awardtype == "book" %}
        <a href="{% url 'awards_books' %}" class="books">Knihy</a>
    {% elif award.awardtype == "game" %}
        <a href="{% url 'awards_games' %}" class="games">Hry</a>
    {% endif %}

    <span> / </span>
    <a href="{% url 'admin_awards' %}" 
        class="{% if award.awardtype == 'film' %}movies
        {% elif award.awardtype == 'book' %}books
        {% elif award.awardtype == 'game' %}games{% endif %}">Spr치va ocen캩n칤</a>
    <span> / </span>
    <a href="{% url 'admin_award_nominees' award.metaawardid %}" 
        class="{% if award.awardtype == 'film' %}movies
        {% elif award.awardtype == 'book' %}books
        {% elif award.awardtype == 'game' %}games{% endif %}">{{ award.awardname }} {{ award.year }}</a>
    <span> / </span>
    <span class="admin-awd-title">P콏idat nominaci</span>
</h2>

<div class="admin-panel">
    <h2 class="after">
        游닇 P콏idat nominaci 
        <small class="addnom-heading-sub">({{ award.awardname }} {{ award.year }})</small>
    </h2>

    <p class="addnom-type" style="width: 100%;">
        Typ ocen캩n칤:
        {% if type == 'film' %}
            <span class="addnom-strong">Film</span>
        {% elif type == 'kniha' %}
            <span class="addnom-strong">Kniha</span>
        {% elif type == 'hra' %}
            <span class="addnom-strong">Hra</span>
        {% endif %}
    </p>

    <div class="admin-panel-body">
        {% if form.non_field_errors %}
            <div class="addnom-alert addnom-alert-error">
                {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" novalidate>
            {% csrf_token %}

            <div class="addnom-field">
                <label class="addnom-label" for="search-input">
                    {% if type == 'hra' %}Vyhledat hru
                        {% elif type == 'kniha' %}Vyhledat knihu
                        {% elif type == 'film' %}Vyhledat film
                    {% endif %}
                </label>

                <input id="search-input" type="text" class="addnom-input" placeholder="Za캜n캩te ps치t..." autocomplete="off">

                <div class="addnom-help">Za캜n캩te ps치t n치zev (min. 2 znaky).</div>
            </div>

            {% if type == 'film' %}
                <div class="addnom-field">
                    <label class="addnom-label" for="id_movieid">Vyberte film</label>
                    {{ form.movieid }}
                </div>

                {% elif type == 'kniha' %}
                    <div class="addnom-field">
                        <label class="addnom-label" for="id_bookid">Vyberte knihu</label>
                        {{ form.bookid }}
                    </div>

                {% elif type == 'hra' %}
                    <div class="addnom-field">
                        <label class="addnom-label" for="id_gameid">Vyberte hru</label>
                        {{ form.gameid }}
                    </div>
            {% endif %}

            <div class="addnom-checkbox">
                <label class="addnom-check">
                    {{ form.winner }} <span>{{ form.winner.label }}</span>
                </label>

                {% if form.winner.help_text %}
                    <div class="addnom-help">{{ form.winner.help_text }}</div>
                {% endif %}
            </div>

            <button type="submit" class="btn 
                {% if award.awardtype == 'book' %}
                    add-book
                {% elif award.awardtype == 'film' %}
                    add-movie
                {% elif award.awardtype == 'game' %}
                    add-game
                {% else %}
                    btn-secondary
                {% endif %}">
                &#10133; P콏idat nominaci
            </button>

        </form>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const type = "{{ type }}";
        const searchInput = document.getElementById("search-input");
        let selectField = null;
        let url = "";

        if (type === "hra") {
            selectField = document.getElementById("id_gameid");
            url = "{% url 'ajax_search_games' %}";
        } else if (type === "kniha") {
            selectField = document.getElementById("id_bookid");
            url = "{% url 'ajax_search_books' %}";
        } else if (type === "film") {
            selectField = document.getElementById("id_movieid");
            url = "{% url 'ajax_search_movies' %}";
        }

        if (searchInput && selectField && url) {
            let searchTimeout;

            searchInput.addEventListener("input", function () {
                const query = searchInput.value.trim();
                if (searchTimeout) clearTimeout(searchTimeout);

                if (query.length < 2) {
                    selectField.innerHTML = '<option value="">Za캜n캩te ps치t pro vyhled치n칤...</option>';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    fetch(url + "?q=" + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        selectField.innerHTML = "";
                        if (!data.results || data.results.length === 0) {
                            const option = document.createElement("option");
                            option.value = "";
                            option.text = "콯치dn칠 v칳sledky";
                            option.disabled = true;
                            selectField.appendChild(option);
                            return;
                        }

                        const emptyOption = document.createElement("option");
                        emptyOption.value = "";
                        emptyOption.text = "-- Vyberte --";
                        selectField.appendChild(emptyOption);

                        data.results.forEach(item => {
                            const option = document.createElement("option");
                            option.value = item.id;
                            option.text = item.text;
                            selectField.appendChild(option);
                        });
                    })
                    .catch(error => {
                        selectField.innerHTML = '<option value="">Chyba p콏i vyhled치v치n칤</option>';
                    });
                }, 300);
            });
        }
    });
</script>

{% endblock %}
