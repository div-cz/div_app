{% extends "awards/base.html" %}
{% load static %}

{% block title %}Přidat nominaci - {{ award.awardname }} {{ award.year }} - DIV.cz{% endblock %}

{% block content %}
<link href="{% static 'css/navbar_together.css' %}" rel="stylesheet">

<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'awards_index' %}">Ocenění</a></li>
      <li class="breadcrumb-item"><a href="{% url 'admin_awards' %}">Správa ocenění</a></li>
      <li class="breadcrumb-item"><a href="{% url 'admin_award_nominees' award.metaawardid %}">{{ award.awardname }} {{ award.year }}</a></li>
      <li class="breadcrumb-item active">Přidat nominaci</li>
    </ol>
  </nav>

  <h1 class="mb-3">&#128221; Přidat nominaci <small class="text-muted">({{ award.awardname }} {{ award.year }})</small></h1>

  <p class="mb-3">
    Typ ocenění:
    {% if type == 'film' %}<span class="fw-bold">&#127916; Film</span>
    {% elif type == 'kniha' %}<span class="fw-bold">&#128218; Kniha</span>
    {% elif type == 'hra' %}<span class="fw-bold">&#127918; Hra</span>
    {% endif %}
  </p>

  {% if form.non_field_errors %}
  <div class="alert alert-danger">
    {% for error in form.non_field_errors %}
      <div>{{ error }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="mb-3">
      <label for="search-input" class="form-label">
        {% if type == 'hra' %}Vyhledat hru
        {% elif type == 'kniha' %}Vyhledat knihu
        {% elif type == 'film' %}Vyhledat film
        {% endif %}
      </label>
      <input id="search-input" type="text" class="form-control" placeholder="Začněte psát název pro vyhledání..." autocomplete="off">
      <div class="form-text">Začněte psát název pro vyhledání (minimum 2 znaky)</div>
    </div>

    {% if type == 'film' %}
      <div class="mb-3">
        <label for="id_movieid" class="form-label">Vyberte film</label>
        {{ form.movieid }}
        {{ form.movieid.errors }}
      </div>
    {% elif type == 'kniha' %}
      <div class="mb-3">
        <label for="id_bookid" class="form-label">Vyberte knihu</label>
        {{ form.bookid }}
        {{ form.bookid.errors }}
      </div>
    {% elif type == 'hra' %}
      <div class="mb-3">
        <label for="id_gameid" class="form-label">Vyberte hru</label>
        {{ form.gameid }}
        {{ form.gameid.errors }}
      </div>
    {% endif %}

    <div class="mb-3">
      <div class="form-check">
        {{ form.winner }}
        <label class="form-check-label" for="id_winner">{{ form.winner.label }}</label>
      </div>
      {% if form.winner.help_text %}
      <div class="form-text">{{ form.winner.help_text }}</div>
      {% endif %}
      {{ form.winner.errors }}
    </div>

    <div class="d-flex justify-content-between">
      <a href="{% url 'admin_award_nominees' award.metaawardid %}" class="btn btn-secondary">&#8592; Zpět</a>
      <button type="submit" class="btn btn-success">&#10133; Přidat nominaci</button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const type = "{{ type }}";
  const searchInput = document.getElementById("search-input");
  let selectField = null;
  let url = "";

  if (type === "hra") {
    selectField = document.getElementById("id_gameid");
    url = "{% url 'ajax_search_games' %}";
  } else if (type === "kniha") {
    selectField = document.getElementById("id_bookid");
    url = "{% url 'ajax_search_books' %}";
  } else if (type === "film") {
    selectField = document.getElementById("id_movieid");
    url = "{% url 'ajax_search_movies' %}";
  }

  if (searchInput && selectField && url) {
    let searchTimeout;

    searchInput.addEventListener("input", function () {
      const query = searchInput.value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);

      if (query.length < 2) {
        selectField.innerHTML = '<option value="">Začněte psát pro vyhledání...</option>';
        return;
      }

      searchTimeout = setTimeout(() => {
        fetch(url + "?q=" + encodeURIComponent(query))
          .then(response => response.json())
          .then(data => {
            selectField.innerHTML = "";
            if (!data.results || data.results.length === 0) {
              const option = document.createElement("option");
              option.value = "";
              option.text = "Žádné výsledky";
              option.disabled = true;
              selectField.appendChild(option);
              return;
            }

            const emptyOption = document.createElement("option");
            emptyOption.value = "";
            emptyOption.text = "-- Vyberte --";
            selectField.appendChild(emptyOption);

            data.results.forEach(item => {
              const option = document.createElement("option");
              option.value = item.id;
              option.text = item.text;
              selectField.appendChild(option);
            });

            selectField.selectedIndex = 1;
          })
          .catch(error => {
            selectField.innerHTML = '<option value="">Chyba při vyhledávání</option>';
          });
      }, 300);
    });
  }
});
</script>
{% endblock %}
