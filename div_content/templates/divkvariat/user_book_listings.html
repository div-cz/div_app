{% extends "divkvariat/base.html" %}
{% load humanize %}

{% block title %}
{{ profile_user.username }} ‚Äì Moje nab√≠dky | DIVkvari√°t
{% endblock %}

{% block content %}

<div class="page page-wide">
    <h1 class="page-title">
        {{ profile_user.username }} ‚Äì Moje nab√≠dky
    </h1>

    <p class="page-description">
        P≈ôehled v≈°ech va≈°ich prodej≈Ø, popt√°vek a archivovan√Ωch nab√≠dek.
    </p>

    <!-- TABS -->
    <div class="tabs">
        {% for key,label in tabs %}
            <a href="?type={{ key }}"
            class="tab {% if filter_type == key %}tab-active{% endif %}">
                {{ label }}
            </a>
        {% endfor %}
    </div>

    <!-- ≈òAZEN√ç -->
    <form method="get" class="filter-bar">
        <input type="hidden" name="type" value="{{ filter_type }}">

        <span class="filter-label">≈òadit:</span>
        <label class="filter-option">
            <input type="radio" name="order" value="date"
                   {% if order == "date" %}checked{% endif %}>
            podle data
        </label>

        <label class="filter-option">
            <input type="radio" name="order" value="alpha" {% if order == "alpha" %}checked{% endif %}>
            A‚ÄìZ
        </label>

        <button type="submit" class="btn-secondary">
            Pou≈æ√≠t
        </button>
    </form>

    <!-- ABECEDA -->
    <div class="alphabet-filter">
        <a href="?type={{ filter_type }}&order={{ order }}" class="alphabet-item {% if not active_letter %}alphabet-active{% endif %}">
            V≈°e
        </a>

        {% for letter in alphabet %}
            <a href="?type={{ filter_type }}&order={{ order }}&letter={{ letter }}" class="alphabet-item {% if active_letter == letter %}alphabet-active{% endif %}">
                {{ letter }}
            </a>
        {% endfor %}
    </div>

    <!-- FORMUL√Å≈ò -->
    <form method="post">
        {% csrf_token %}
        {% if listings %}
            <div class="listing-grid">
                {% for listing in listings %}
                    <div class="listing-card">

                    {% if listing.status == "ACTIVE" %}
                        <label class="listing-select">
                            <input type="checkbox" name="selected_ids"
                                value="{{ listing.booklistingid }}">
                            vybrat
                        </label>
                    {% endif %}

                    <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}"
                    class="listing-title">
                        {{ listing.book.titlecz|default:listing.book.title }}
                    </a>

                    <p class="listing-author">
                        {{ listing.book.author }}
                    </p>

                    {% if listing.status == "ACTIVE" and listing.listingtype != "GIVE" %}
                        <div class="listing-price-edit">
                            <label>Cena:</label>
                            <input type="number"
                                name="price_{{ listing.booklistingid }}"
                                value="{{ listing.price|floatformat:0 }}"
                                min="0">
                            <span>Kƒç</span>
                        </div>
                        {% else %}
                        <p class="listing-price
                            {% if listing.listingtype == 'GIVE' %}listing-price-give{% endif %}">
                            {% if listing.listingtype == "GIVE" %}
                                Daruji
                            {% else %}
                                {{ listing.price|intcomma }} Kƒç
                            {% endif %}
                        </p>
                    {% endif %}

                    <p class="listing-meta">
                        <strong>{{ listing.get_listingtype_display }}</strong> ¬∑
                        <span class="listing-status listing-status-{{ listing.status|lower }}">
                            {{ listing.get_status_display }}
                        </span><br>
                        {{ listing.createdat|date:"j. n. Y" }}
                    </p>

                    <div class="listing-actions">
                        {% if listing.status == "ACTIVE" %}
                            <a href="{% url 'listing_detail_edit' listing.book.url listing.booklistingid %}">
                                Upravit
                            </a>
                        {% endif %}

                        <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}">
                            Detail
                        </a>

                        {% if listing.status == "ACTIVE" %}
                            <a href="{% url 'cancel_sell' listing.booklistingid %}"
                            class="action-danger"
                            onclick="return confirm('Opravdu chcete zru≈°it tuto nab√≠dku?')">
                                Zru≈°it
                            </a>
                        {% endif %}
                    </div>

                </div>
            {% endfor %}
        </div>

        <!-- HROMADN√â AKCE -->
        <div class="bulk-actions">
            <button type="submit" name="action" value="update_prices"
                    class="btn-primary">
                üíæ Ulo≈æit zmƒõny cen
            </button>

            <button type="submit" name="action" value="cancel"
                    class="btn-danger"
                    onclick="return confirm('Opravdu chcete zru≈°it vybran√© nab√≠dky?')">
                üóëÔ∏è Zru≈°it vybran√©
            </button>

            <span class="bulk-info">
                Celkem: {{ listings.paginator.count }} nab√≠dek
            </span>
        </div>

        {% else %}
            <div class="empty-state">
                <p>Zat√≠m zde nem√°te ≈æ√°dn√© nab√≠dky.</p>
                <a href="{% url 'listing_add_book' %}" class="btn-primary">
                    + P≈ôidat prvn√≠ nab√≠dku
                </a>
            </div>
        {% endif %}
    </form>

    <!-- PAGINACE -->
    {% if listings.has_other_pages %}
        <div class="pagination">
            {% if listings.has_previous %}
                <a href="?page={{ listings.previous_page_number }}&type={{ filter_type }}&order={{ order }}{% if active_letter %}&letter={{ active_letter }}{% endif %}">
                    ‚Äπ P≈ôedchoz√≠
                </a>
                {% endif %}

                <span>
                    {{ listings.number }} / {{ listings.paginator.num_pages }}
                </span>

                {% if listings.has_next %}
                <a href="?page={{ listings.next_page_number }}&type={{ filter_type }}&order={{ order }}{% if active_letter %}&letter={{ active_letter }}{% endif %}">
                    Dal≈°√≠ ‚Ä∫
                </a>
            {% endif %}
        </div>
    {% endif %}

</div>

{% endblock %}
