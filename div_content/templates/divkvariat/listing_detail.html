{% extends "divkvariat/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
    {{ listing.get_listingtype_display }} – {{ book.titlecz|default:book.title }} | DIVkvariát
{% endblock %}

{% block meta %}
<meta name="description" content="{{ book.titlecz|default:book.title }} – {{ listing.get_listingtype_display }} na DIVkvariátu.">
{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto py-10">

    <!-- NAVIGACE -->
    <div class="mb-6">
        <a href="/" 
           class="text-green-700 hover:underline">DIVkvariát</a>
        <span class="mx-2">/</span>
        <a href="{% if listing.listingtype == 'SELL' %}/nabidky/{% else %}/poptavky/{% endif %}"
           class="text-green-700 hover:underline">
            {% if listing.listingtype == 'SELL' %}Nabídky{% else %}Poptávky{% endif %}
        </a>
    </div>



    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

        <!-- HLAVNÍ SLOUPEC -->
        <div class="lg:col-span-2">

            <!-- INFO O KNIZE -->
            <div class="flex gap-6 mb-10">

                <a href="/kniha/{{ book.url }}">
                    {% if book.img == "noimg.png" %}
                    <img src="https://div.cz/static/img/book/book.png" 
                         class="w-40 h-auto rounded-lg shadow">
                    {% elif book.img == "GoogleID" %}
                    <img src="https://books.google.com/books/content?id={{ book.googleid }}&printsec=frontcover&img=1&zoom=1"
                         class="w-40 h-auto rounded-lg shadow">
                    {% else %}
                    <img src="https://media.div.cz/knihy/{{ book.img }}"
                         class="w-40 h-auto rounded-lg shadow">
                    {% endif %}
                </a>

                <div class="flex-1">
                    <h1 class="text-3xl font-bold mb-1">
                        <a href="/kniha/{{ book.url }}" class="hover:underline">
                            {{ book.titlecz|default:book.title }}
                        </a>
                    </h1>
                    <p class="text-gray-700 mb-4">{{ book.author }}</p>

                    <p class="text-xl">
                        <strong>Cena:</strong>
                        {% if listing.listingtype == "GIVE" %}
                            Daruji
                        {% else %}
                            {{ listing.price|price }} Kč
                        {% endif %}

                        {% if listing.status == "ACTIVE" %}
                        <span class="text-gray-500 ml-1 text-sm">
                            (poštovné od 
                            {{ listing.shippingoptions|div_split:","|first|div_split:":"|div_get:1 }} Kč)
                        </span>
                        {% elif listing.shipping %}
                        <span class="text-gray-500 ml-1 text-sm">
                            (+ {{ listing.shipping|price }} Kč poštovné)
                        </span>
                        {% endif %}
                    </p>

                </div>
            </div>

            <!-- UPRAVIT NABÍDKU -->
            {% if listing.user == user and listing.status == 'ACTIVE' %}
            <div class="mb-6">
                <a href="{% url 'listing_detail_edit' book_url=book.url listing_id=listing.booklistingid %}"
                   class="add-book "
                   style="">
                    Upravit nabídku
                </a>
            </div>
            {% endif %}

            <!-- ALERTY PRO ODESLÁNÍ / HODNOCENÍ / ATD. -->
{% if listing.status == 'RESERVED' and listing.user == user %}
<div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-300">
    <p class="font-semibold">
        Kniha byla rezervována – čekáme na zaplacení kupujícím.
    </p>
</div>
{% endif %}

            {% if listing.status == 'PAID' and listing.user == user %}
                {% if listing.shipping and listing.shipping > 0 and listing.shippingaddress %}
                <div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-300">
                    <p class="font-semibold">Knihu odešlete na adresu:</p>
                    <p>{{ listing.shippingaddress }}</p>
                </div>
                {% elif listing.shipping == 0 %}
                <div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-300">
                    <p class="font-semibold">Osobní odběr – domluvte se s kupujícím.</p>
                    <p>Kontakt: {{ listing.buyer.email }}{% if buyer_phone %}, tel: {{ buyer_phone }}{% endif %}</p>
                </div>
                {% endif %}
            {% endif %}


                <!-- POTVRZENÍ PŘEVZETÍ KUPUJÍCÍM -->
                {% if listing.status == 'PAID' and listing.buyer == user %}
                <div class="p-4 mb-10 rounded-lg bg-green-50 border border-green-300">
                    Čekáme na potvrzení, že prodejce odeslal/předal knihu.
                    <p class="mt-2">
                        
                        <!--Kontaktovat prodejce můžete přes
                        <a href="chat"
                           class="text-blue-700 underline">Chat ✉</a>-->
                    </p>
                </div>
                {% endif %}



{% if listing.status == 'SHIPPED' and listing.user == user %}
<div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-300">
    <p class="font-semibold">
        Kniha byla odeslána. Čekáme na potvrzení převzetí kupujícím.
    </p>
</div>
{% endif %}


            {% if listing.status == 'COMPLETED' %}
                {% if listing.user == user and not listing.buyerrating %}
                <div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-300">
                    Ohodnoťte prosím kupujícího.
                </div>
                {% endif %}
                {% if listing.buyer == user and not listing.sellerrating %}
                <div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-300">
                    Ohodnoťte prosím prodávajícího.
                </div>
                {% endif %}
            {% endif %}

            <!-- HLAVNÍ INFO BOX -->
            <div class="bg-white shadow rounded-lg p-6 mb-10">

                <div class="flex justify-between mb-6">

                    <div>
                        <p class="text-gray-600">Cena:</p>
                        <p class="text-2xl font-semibold text-green-700">
                            {% if listing.listingtype == 'GIVE' %}
                                Daruji
                            {% else %}
                                {{ listing.price|price }} Kč
                            {% endif %}
                        </p>
                    </div>

                    <div class="text-right">
                        <p class="text-sm text-gray-500">
                            {{ listing.createdat|date:"j. n. Y" }}
                        </p>
                        <span class="px-3 py-1 rounded-full text-sm font-bold text-white
                            {% if listing.status == 'ACTIVE' %} bg-green-600
                            {% elif listing.status == 'RESERVED' %} bg-orange-500
                            {% elif listing.status == 'PAID' %} bg-blue-600
                            {% elif listing.status == 'SHIPPED' %} bg-purple-600
                            {% elif listing.status == 'COMPLETED' %} bg-gray-800
                            {% elif listing.status == 'CANCELLED' %} bg-red-700
                            {% endif %}
                        ">
                            {{ listing.get_status_display }}
                        </span>
                    </div>
                </div>

                <!-- POPIS -->
                {% if listing.description %}
                <div class="mb-6">
                    <p class="font-medium text-gray-700 mb-1">Popis:</p>
                    <div class="text-gray-800">{{ listing.description|linebreaks }}</div>
                </div>
                {% endif %}



<!-- FOTOGALERIE -->
<div class="mb-8">
    <h3 class="text-xl font-semibold mb-3">Fotografie</h3>

    {% if listing.images.all %}
    <div class="flex flex-wrap gap-3 mb-4">
        {% for img in listing.images.all %}
        <div class="relative group">

            <img 
                src="{{ img.image.url }}" 
                class="w-32 h-auto rounded shadow cursor-pointer"
                onclick="openImageModal('{{ img.image.url }}')"
            >

            {% if listing.user == user %}
            <a href="{% url 'listing_delete_image' img.id %}"
               class="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition"
               onclick="return confirm('Smazat fotografii?');">
               ×
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if listing.user == user and listing.status == 'ACTIVE' %}
    <form method="post" enctype="multipart/form-data"
          action="{% url 'listing_upload_image' listing.booklistingid %}"
          class="mt-4">

        {% csrf_token %}

        <input type="file" name="images" multiple
               accept="image/jpeg,image/png,image/webp,image/gif,image/heic,image/heif,image/avif"
               class="border rounded px-3 py-2 w-full">

        <p class="text-sm text-gray-600 mt-1">
            Podporované formáty: JPG, PNG, WebP, GIF, HEIC, HEIF, AVIF
        </p>
        
        <button type="submit"
                class="add-book mt-3">
            Nahrát fotografie
        </button>
    </form>
    {% endif %}
</div>


                <!-- PARAMETRY -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                    {% if listing.condition %}
                    <p><strong>Stav:</strong> {{ listing.get_condition_display }}</p>
                    {% endif %}

                    {% if listing.location %}
                    <p><strong>Lokalita:</strong> {{ listing.location }}</p>
                    {% endif %}



{% if listing.editionyear %}
<p><strong>Rok vydání:</strong> {{ listing.editionyear }}</p>
{% endif %}

{% if listing.firstedition %}
<p><strong>První vydání</strong></p>
{% endif %}

{% if listing.edition_note %}
<p><strong>Ediční poznámka:</strong> {{ listing.edition_note }}</p>
{% endif %}



                    <p>
                        <strong>Osobní převzetí:</strong>
                        {% if listing.personal_pickup %}Ano{% else %}Ne{% endif %}
                    </p>



<p>
{% if listing.shippingoptions %}
    <div class="mt-2 text-sm text-gray-700">

        {# --- Poštovné od (vezmeme nejnižší > 0) --- #}
        {% with prices="" %}
            {% for opt in listing.shippingoptions|div_split:"," %}
                {% with p=opt|div_split:":"|div_get:1 %}
                    {% if p != "0" %}
                        {% if forloop.first %}
                            <strong>Poštovné od {{ p }} Kč</strong><br>
                        {% endif %}
                    {% endif %}
                {% endwith %}
            {% endfor %}
        {% endwith %}

        {# --- Jednotlivé možnosti lidsky --- #}
        {% for opt in listing.shippingoptions|div_split:"," %}
            {% with key=opt|div_split:":"|first price=opt|div_split:":"|div_get:1 %}
                {% if key == "ZASILKOVNA" %}
                    Zásilkovna: {{ price }} Kč<br>
                {% elif key == "BALIKOVNA" %}
                    Balíkovna: {{ price }} Kč<br>
                {% elif key == "POSTA" %}
                    Česká pošta: {{ price }} Kč<br>
                {% elif key == "OSOBNI" %}
                    Osobní převzetí zdarma<br>
                {% endif %}
            {% endwith %}
        {% endfor %}

    </div>
{% endif %}
</p>



                    <p>
                        <strong>
                        
        {% if listing.listingtype == 'BUY' %}
            Poptávající:
        {% else %}
            Prodávající:
        {% endif %}
        
                        </strong>
                        <a href="{% url 'user_sell_listings' listing.user.id %}" 
                           class="text-green-700 hover:underline ml-1">
                            {{ listing.user.username }}
                        </a>
                        {% if user != listing.user %}
                        <!--
                        <a href="chat" 
                           class="ml-2 text-green-700">
                            <i class="fas fa-envelope"></i>
                        </a>-->
                        {% endif %}
                    </p>
                </div>

            </div>

            <!-- FORMULÁŘE / REZERVACE / PLATBY / DOKONČENÍ / PROCES PRODEJE -->

            {% if user.is_authenticated %}

                <!-- FORMULÁŘ PRO REZERVACI (jen ACTIVE & uživatel není prodejce) -->
                {% if listing.status == 'ACTIVE' and user != listing.user %}
                <div class="bg-white shadow rounded-lg p-6 mb-10">

                    <h3 class="text-xl font-semibold mb-4">Rezervace knihy</h3>

                    <form method="post" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="reserve_listing" value="1">

                        <!-- Adresa -->
                        <div>
                            <label for="shippingaddress" class="font-medium">Kam si přejete knihu zaslat?</label>
                            <textarea
                                name="shippingaddress"
                                id="shippingaddress"
                                rows="4"
                                required
                                class="w-full border rounded-lg px-3 py-2 mt-1"
                                placeholder="Jméno, ulice, město, PSČ"
                            >{{ request.user.userprofile.shippingaddress|default:"" }}</textarea>
                            <p class="text-sm text-gray-600">Nejvýhodnější varianta je výchozí Zásilkovna podle adresy.</p>
                        </div>

                        <!-- Telefon -->
                        <div>
                            <label for="phone" class="font-medium">Telefon (pro zásilkovnu/balíkovnu):</label>
                            <input
                                type="tel"
                                name="phone"
                                id="phone"
                                required
                                value="{{ request.user.userprofile.phone|default:'' }}"
                                class="w-full border rounded-lg px-3 py-2"
                            >
                        </div>

                        <!-- Výběr dopravy -->
                        <div>
                            <label class="font-medium">Způsob doručení:</label>
                            <select
                                name="shipping_option"
                                id="shipping_option"
                                class="w-full border rounded-lg px-3 py-2 mt-1"
                                onchange="updateShippingPrice()"
                            >
                                {% for option in listing.shippingoptions|div_split:"," %}
                                <option value="{{ option|div_split:":"|div_get:1 }}">
                                    {{ option|div_split:":"|div_get:0|format_shipping_name }} – {{ option|div_split:":"|div_get:1 }} Kč
                                </option>
                                {% endfor %}
                            </select>

                            <input type="hidden" name="shipping" id="shipping">
                        </div>

                        <script>
                        function updateShippingPrice() {
                            const select = document.getElementById("shipping_option");
                            const hidden = document.getElementById("shipping");
                            hidden.value = select.value;
                        }
                        document.addEventListener("DOMContentLoaded", updateShippingPrice);
                        </script>

                        <!-- Komise -->
                        <div>
                            <label class="font-medium">Příspěvek na chod webu (volitelný):</label>
                            <input
                                type="number"
                                name="commission"
                                min="0"
                                value="10"
                                class="w-full border rounded-lg px-3 py-2"
                            >
                        </div>

                        <!-- Právní souhlas -->
                        <div class="flex gap-2 items-start">
                            <input type="checkbox" name="agree_terms" id="agree_terms" required>
                            <label for="agree_terms" class="text-sm text-gray-700">
                                Souhlasím s předáním údajů prodávajícímu za účelem odeslání knihy
                                a s <a href="/podminky" target="_blank" class="text-green-700 underline">Podmínkami používání</a>
                                a <a href="/ochrana-osobnich-udaju" target="_blank" class="text-green-700 underline">Ochranou osobních údajů</a>.
                            </label>
                        </div>

                        <button type="submit" class="add-book w-full">Rezervovat knihu</button>

                    </form>
                </div>
                {% endif %}

                <!-- PLATBA (RESERVED & kupující) -->
                {% if listing.status == 'RESERVED' and listing.buyer == user %}
                <div class="bg-white shadow rounded-lg p-6 mb-10">

                    <h3 class="text-xl font-semibold mb-4">Platební údaje</h3>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="font-medium">Cena knihy:</p>
                            <p>{{ listing.price|default:"0"|price }} Kč</p>
                        </div>

                        {% if listing.shipping %}
                        <div>
                            <p class="font-medium">Poštovné:</p>
                            <p>{{ listing.shipping|price }} Kč</p>
                        </div>
                        {% endif %}

                        {% if listing.commission %}
                        <div>
                            <p class="font-medium">Provozní poplatek:</p>
                            <p>{{ listing.commission|price }} Kč</p>
                        </div>
                        {% endif %}

                        <div>
                            <p class="font-medium">Celkem k úhradě:</p>
                            <p class="text-xl font-semibold text-blue-600">
                                {{ payment_info.total|price }} Kč
                            </p>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6 pt-4">
                        <div>
                            <h4 class="font-medium mb-2">Bankovní převod</h4>
                            <ul class="space-y-1">
                                <li><strong>Číslo účtu:</strong> 2602912559/2010</li>
                                <li><strong>IBAN:</strong> CZ5620100000002602912559</li>
                                <li><strong>SWIFT:</strong> FIOBCZPPXXX</li>
                                <li><strong>Variabilní symbol:</strong> {{ payment_info.variable_symbol }}</li>
                                <li><strong>Poznámka:</strong> {{ payment_info.note }}</li>
                            </ul>
                        </div>

                        <div class="flex justify-center">
                            <img src="data:image/png;base64,{{ payment_info.qr_code }}"
                                 class="max-w-[200px]" alt="QR platba">
                        </div>
                    </div>

                </div>
                {% endif %}

                <!-- HODNOCENÍ PRODÁVAJÍCÍHO -->
                {% if can_rate_seller %}
                <div class="bg-white shadow rounded-lg p-6 mb-10">

                    <h3 class="text-xl font-semibold mb-4">Ohodnotit prodávajícího {{ listing.user.username }}</h3>

                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="block text-gray-700 mb-1">Hodnocení (1–5):</label>
                            <select name="rating"
                                    class="w-full border rounded-lg px-3 py-2">
                                <option value="5">5 – Výborné</option>
                                <option value="4">4 – Velmi dobré</option>
                                <option value="3">3 – Dobré</option>
                                <option value="2">2 – Dostatečné</option>
                                <option value="1">1 – Nedostatečné</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 mb-1">Komentář:</label>
                            <textarea name="comment" rows="3"
                                      class="w-full border rounded-lg px-3 py-2"></textarea>
                        </div>

                        <button type="submit" name="sellerrating" value="1"
                                class="add-book">
                            Odeslat hodnocení
                        </button>
                    </form>

                </div>
                {% endif %}

                <!-- HODNOCENÍ KUPUJÍCÍHO -->
                {% if can_rate_buyer %}
                <div class="bg-white shadow rounded-lg p-6 mb-10">

                    <h3 class="text-xl font-semibold mb-4">Ohodnotit kupujícího {{ listing.buyer.username }}</h3>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-1">Hodnocení (1–5):</label>
                            <select name="rating"
                                    class="w-full border rounded-lg px-3 py-2">
                                <option value="5">5 – Výborné</option>
                                <option value="4">4 – Velmi dobré</option>
                                <option value="3">3 – Dobré</option>
                                <option value="2">2 – Dostatečné</option>
                                <option value="1">1 – Nedostatečné</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 mb-1">Komentář:</label>
                            <textarea name="comment" rows="3"
                                      class="w-full border rounded-lg px-3 py-2"></textarea>
                        </div>

                        <button type="submit" name="buyerrating" value="1"
                                class="add-book">
                            Odeslat hodnocení
                        </button>

                    </form>

                </div>
                {% endif %}

                <!-- POTVRZENÍ ODESLÁNÍ PRODÁVAJÍCÍM -->
                {% if listing.status == 'PAID' and user == listing.user %}
                <div class="p-4 mb-10 rounded-lg bg-green-50 border border-green-300">
                    Kupující zaplatil. Odešlete prosím knihu kupujícímu.

                <form method="post" class="mt-4">
                    {% csrf_token %}
                    <button type="submit" name="shipping_listing" class="add-book">
                        Potvrdit odeslání / předání knihy
                    </button>
                </form>

                </div>
                {% endif %}



{% if can_complete_transaction %}
<div class="p-4 mb-10 rounded-lg bg-green-50 border border-green-300">
    Prodejce odeslal knihu, prosím potvrďte její převzetí.

    <form method="post" class="mt-4">
        {% csrf_token %}
        <button type="submit"
                name="complete_listing"
                class="add-book">
            Potvrdit převzetí knihy
        </button>
    </form>
</div>
{% endif %}



                <!-- INFORMACE O PROCESU PRODEJE -->
                {% if listing.buyer == user or listing.user == user %}
                <div class="bg-white shadow rounded-lg p-6 mb-10">

                    <h3 class="text-xl font-semibold mb-4">Informace o procesu prodeje</h3>

                    <p class="mb-4 text-gray-700">
                        Vaše platba je uložena na transparentním účtu neziskové organizace eKultura.
                        Více informací najdete v článku
                        <a href="https://div.cz/jak-nakupovat-knihy"
                           class="text-green-700 underline">Jak nakupovat</a>.
                    </p>

                    <p class="font-medium mb-2">Proces prodeje:</p>

                    <ol class="list-decimal ml-6 space-y-2">

                        <li>
                            <input type="checkbox" disabled
                                   {% if listing.status in 'RESERVED PAID SHIPPED COMPLETED' %}checked{% endif %}>
                            <span class="ml-1 {% if listing.status == 'RESERVED' or listing.status == 'PAID' or listing.status == 'SHIPPED' or listing.status == 'COMPLETED' %}text-green-700 font-semibold{% endif %}">
                                Kupující provedl rezervaci
                            </span>
                        </li>

                        <li>
                            <input type="checkbox" disabled
                                   {% if listing.status in 'PAID SHIPPED COMPLETED' %}checked{% endif %}>
                            <span class="ml-1 {% if listing.status == 'PAID' or listing.status == 'SHIPPED' or listing.status == 'COMPLETED' %}text-green-700 font-semibold{% endif %}">
                                Kupující odeslal platbu
                            </span>
                        </li>

                        <li>
                            <input type="checkbox" disabled
                                   {% if listing.status in 'SHIPPED COMPLETED' %}checked{% endif %}>
                            <span class="ml-1 {% if listing.status == 'SHIPPED' or listing.status == 'COMPLETED' %}text-green-700 font-semibold{% endif %}">
                                Prodejce odeslal/předal knihu
                            </span>
                        </li>

                        <li>
                            <input type="checkbox" disabled
                                   {% if listing.status == 'COMPLETED' %}checked{% endif %}>
                            <span class="ml-1 {% if listing.status == 'COMPLETED' %}text-green-700 font-semibold{% endif %}">
                                Obchod byl dokončen
                            </span>
                        </li>

                    </ol>

                    <!-- DEADLINE – platba -->
                    {% if deadline_date %}
                    <div class="mt-6 p-4 rounded-lg bg-gray-50 border border-gray-200">

                        {% if listing.status == "RESERVED" %}
                            <p class="text-sm">
                                <strong>Platbu prosím dokončete do:</strong>
                                {{ deadline_date|date:"j. n. Y" }}
                            </p>
                            <p class="text-sm text-gray-600">Po tomto datu bude rezervace zrušena.</p>

                        {% elif listing.status == "PAID" %}
                            <p class="text-sm">
                                <strong>Prodejce má potvrdit odeslání do:</strong>
                                {{ deadline_date|date:"j. n. Y" }}
                            </p>
                            <p class="text-sm text-gray-600">
                                Pokud kniha nebude odeslána, objednávka bude zrušena a peníze vráceny.
                            </p>
                        {% endif %}

                    </div>
                    {% endif %}

                    <!-- DEADLINE – doručení -->
                    {% if shipped_deadline %}
                    <div class="mt-6 p-4 rounded-lg bg-gray-50 border border-gray-200">
                        <p class="text-sm">
                            <strong>Potvrďte obdržení knihy do:</strong>
                            {{ shipped_deadline|date:"j. n. Y" }}
                        </p>
                        <p class="text-sm text-gray-600">
                            Po tomto datu se transakce automaticky uzavře.
                        </p>
                    </div>
                    {% endif %}

                    {% if listing.status == 'COMPLETED' %}
                    <div class="mt-6 p-4 rounded-lg bg-gray-50 border border-gray-200">
                        <p class="text-sm">
                            <strong>Obchod byl dokončen dne:</strong>
                            {{ listing.completedat|date:"j. n. Y" }}
                        </p>
                    </div>
                    {% endif %}

                    <!-- ZRUŠENÍ REZERVACE -->
                    {% if can_cancel_reservation %}
                    <form method="post"
                          action="{% url 'cancel_listing_reservation' listing_id=listing.booklistingid %}"
                          class="mt-6">
                        {% csrf_token %}
                        <button type="submit"
                                onclick="return confirm('Opravdu chcete zrušit rezervaci?');"
                                class="add-book">
                            Zrušit rezervaci
                        </button>
                    </form>
                    {% endif %}

                    <!-- ZRUŠENÍ NABÍDKY -->
                    {% if can_cancel_offer %}
                    <form method="post"
                          action="{% url 'cancel_sell' listing_id=listing.booklistingid %}"
                          class="mt-6">
                        {% csrf_token %}
                        <button type="submit"
                                onclick="return confirm('Opravdu chcete zrušit svou nabídku?');"
                                class="add-book" style="background-color:red">
                            Zrušit mou nabídku
                        </button>
                    </form>
                    {% endif %}

                </div>
                {% endif %}

            {% else %}
            <!-- POKUD NENÍ PŘIHLÁŠEN -->
            <p class="mt-6 text-gray-700">
                Pro rezervaci nebo nákup knihy se musíš
                <a href="/prihlaseni/" class="text-green-700 underline">přihlásit</a>
                nebo
                <a href="/registrace/" class="text-green-700 underline">registrovat</a>.
            </p>
            {% endif %}

        </div>

        <!-- PRAVÝ PANEL -->
        <div>

            {% if request.user.is_authenticated %}
            <div class="bg-white shadow rounded-lg p-6 mb-8">

                <h3 class="text-xl font-semibold mb-4">Můj přehled</h3>

                <ul class="space-y-2 text-gray-700">
                    <li><strong>Prodáno knih:</strong> {{ user_sold_books|default:"0" }}</li>
                    <li><strong>Koupeno knih:</strong> {{ user_buyed_books|default:"0" }}</li>
                    <li><strong>Právě prodávám:</strong> {{ user_pending_books|default:"0" }} knih za {{ total_user_pending|default:"0" }} Kč</li>
                    <li><strong>K vyplacení:</strong> {{ total_user_payment|default:"0" }} Kč</li>
                    <li><strong>Vyplaceno:</strong> {{ total_user_paid_amount|default:"0" }} Kč</li>
                </ul>

                {% if total_user_payment > 0 and button_appear and user.userprofile.bankaccount %}
                <form method="post" class="mt-4">
                    {% csrf_token %}
                    <button type="submit" name="request_payout" class="add-book w-full">
                        Vyžádat výplatu
                    </button>
                </form>
                {% endif %}

                {% if not user.userprofile.bankaccount %}
                <p class="mt-4 text-sm text-gray-600">
                    Pro výplatu je nutné vyplnit číslo účtu na
                    <a href="/ucet/upravit/" class="text-green-700 underline">profilu</a>.
                </p>
                {% endif %}

            </div>
            {% endif %}

            <!-- BURZA KNIH -->
            <div class="bg-white shadow rounded-lg p-6">

                <h3 class="text-xl font-semibold mb-2">Burza knih</h3>
                <p class="text-gray-600 mb-4">
                    Nabídek: {{ recent_sell_listings|length }} |
                    Poptávek: {{ recent_buy_listings|length }}
                </p>

                <!-- PRODEJ -->
                <h4 class="font-medium mb-2">Prodej</h4>
                <div class="space-y-3">
                    {% for listing in recent_sell_listings %}
                    <div class="flex gap-3 border p-2 rounded-lg bg-gray-50">

                        <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}">
                            {% if listing.book.img == "noimg.png" %}
                            <img src="/static/img/book/book.png" class="w-16 rounded">
                            {% elif listing.book.img == "GoogleID" %}
                            <img src="https://books.google.com/books/content?id={{ listing.book.googleid }}&printsec=frontcover&img=1&zoom=1"
                                 class="w-16 rounded">
                            {% else %}
                            <img src="https://media.div.cz/knihy/{{ listing.book.img }}"
                                 class="w-16 rounded">
                            {% endif %}
                        </a>

                        <div class="flex-1">
                            <a href="{% url 'listing_detail_sell' listing.book.url listing.booklistingid %}"
                               class="font-medium hover:underline">
                               {{ listing.book.titlecz }}
                            </a>
                            <p class="text-sm text-gray-600">{{ listing.book.author }}</p>
                            <p class="text-sm">
                                {% if listing.price %}{{ listing.price|floatformat:0 }} Kč
                                {% else %}Daruji{% endif %}
                            </p>
                        </div>

                    </div>
                    {% endfor %}
                </div>

                <hr class="my-4">

                <!-- POPTÁVKY -->
                <h4 class="font-medium mb-2">Poptávky</h4>
                <div class="space-y-3">
                    {% for listing in recent_buy_listings %}
                    <div class="flex gap-3 border p-2 rounded-lg bg-gray-50">

                        <a href="{% url 'listing_detail_buy' listing.book.url listing.booklistingid %}">
                            {% if listing.book.img == "noimg.png" %}
                            <img src="/static/img/book/book.png" class="w-16 rounded">
                            {% elif listing.book.img == "GoogleID" %}
                            <img src="https://books.google.com/books/content?id={{ listing.book.googleid }}&printsec=frontcover&img=1&zoom=1"
                                 class="w-16 rounded">
                            {% else %}
                            <img src="https://media.div.cz/knihy/{{ listing.book.img }}"
                                 class="w-16 rounded">
                            {% endif %}
                        </a>

                        <div class="flex-1">
                            <a href="{% url 'listing_detail_buy' listing.book.url listing.booklistingid %}"
                               class="font-medium hover:underline">
                               {{ listing.book.titlecz }}
                            </a>
                            <p class="text-sm text-gray-600">{{ listing.book.author }}</p>
                            <p class="text-sm text-gray-700">
                                {{ listing.price|floatformat:0 }} Kč
                            </p>
                        </div>

                    </div>
                    {% endfor %}
                </div>

            </div>

        </div>

    </div>

</div>

{% endblock %}









